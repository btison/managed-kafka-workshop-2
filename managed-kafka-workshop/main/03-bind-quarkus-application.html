<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Binding a Quarkus application to OpenShift Streams for Apache Kafka :: Red Hat OpenShift Streams for Apache Kafka Workshop</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/managed-kafka-workshop/managed-kafka-workshop/main/03-bind-quarkus-application.html">
    <link rel="prev" href="02-connect-streams-apache-kafka.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/managed-kafka-workshop">Red Hat OpenShift Streams for Apache Kafka Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="managed-kafka-workshop" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-getting-started.html">1. Getting Started with OpenShift Streams for Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#redhataccount">Create a Red Hat Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#kafka">Provision a Kafka instance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#serviceaccount">Create a Service Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#serviceaccountpermissions">Set Permissions for a Service Account</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#topic">Create a Kafka Topic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-connect-streams-apache-kafka.html">2. Connecting OpenShift Streams for Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-connect-streams-apache-kafka.html#devsandboxaccess">Get access to the Developer Sandbox</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-connect-streams-apache-kafka.html#connectopenshiftstreams">Connect the OpenShift Streams for Apache Kafka instance to your OpenShift project</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-bind-quarkus-application.html">3. Binding a Quarkus application to OpenShift Streams for Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deployquarkusproducerapplication">Deploying a Quarkus producer application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#bindquarkusapp">Binding your Quarkus application to Streams for Apache Kafka</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deployquarkusconsumerapplication">Deploying and binding a Quarkus consumer application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Red Hat OpenShift Streams for Apache Kafka Workshop</a></li>
    <li><a href="03-bind-quarkus-application.html">3. Binding a Quarkus application to OpenShift Streams for Apache Kafka</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/btison/managed-kafka-workshop-2/edit/main/documentation/modules/ROOT/pages/03-bind-quarkus-application.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Binding a Quarkus application to OpenShift Streams for Apache Kafka</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>As a developer of applications and services, you can connect Quarkus applications to Kafka instances in OpenShift Streams for Apache Kafka.</p>
</div>
<div class="paragraph">
<p>Quarkus is a Kubernetes-native Java framework made for Java virtual machines (JVMs) and native compilation, and optimized for serverless, cloud, and Kubernetes environments. Quarkus is designed to work with popular Java standards, frameworks, and libraries like Eclipse MicroProfile and Spring, as well as Apache Kafka, RESTEasy (JAX-RS), Hibernate ORM (JPA), Infinispan, Camel, and many more.</p>
</div>
<div class="paragraph">
<p>You can bind a Quarkus application to your Kafka instance using <em>Kubernetes Service Binding</em>. Service Binding allows you to communicate connection details and secrets to an application to allow it to bind to a service. In this context, a service can be anything: a Kafka instance, a NoSQL database, etc. By using Service Binding, we no longer need to configure connection details (host, port), authentication mechanisms (SASL, OAuth) and credentials (username/password, client id/client secret) in an application. Instead, Service Binding injects these variables into your application container (as files or environment variables) for your application to consume. The Quarkus Kubernetes Service Binding extension enables Quarkus applications to automatically pickup these variables, injected as files, from the container&#8217;s filesystem, removing the need to specify any configuration settings in the application resources (e.g configuration files) themselves.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployquarkusproducerapplication"><a class="anchor" href="#deployquarkusproducerapplication"></a>Deploying a Quarkus producer application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the first task, you will deploy a Quarkus application that produces messages to a Kafka instance. It is a simple application that sends stock price messages at a regular interval to a Kafka topic.</p>
</div>
<div class="paragraph">
<p>The source code of this Quarkus application can be found in <a href="https://github.com/btison/stocks-kafka-producer">this GitHub repo</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve pre-build the container image with the Quarkus application so that you can easily deploy it in your OpenShift project on the Developer Sandbox.</p>
</div>
<div class="paragraph">
<p>To deploy the Quarkus application:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you are in the <em>Developer Perspective</em> of your sandbox OpenShift environment.</p>
</li>
<li>
<p>In the navigation menu on the left, click <strong>+Add</strong>.</p>
</li>
<li>
<p>Make sure that your OpenShift Project, which you can see at the top of the <strong>Add</strong> window, is set to <code>{username}-dev</code> (where <code>{username}</code> is your username in the sandbox OpenShift environment).</p>
</li>
<li>
<p>Click on the <strong>Container images</strong> card.</p>
</li>
<li>
<p>In the Image name from external registry field, enter:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quay.io/btison/stocks-kafka-producer</code></pre>
</div>
</div>
</li>
<li>
<p>In the <strong>Runtime icon</strong> field, select <code>quarkus</code>.</p>
</li>
<li>
<p>Enter <code>stocks</code> in the <strong>Application name</strong> field.</p>
</li>
<li>
<p>Enter <code>stocks-kafka-producer</code> in the <strong>Name</strong> field.</p>
</li>
<li>
<p>Uncheck the <strong>Create a route to the Application</strong> check box.</p>
</li>
<li>
<p>Leave the other fields set to their default values and click the <strong>Create</strong> button. This will create a new OpenShift Deployment for your Quarkus application.</p>
</li>
<li>
<p>You will see the deployment of your Quarkus application in the <em>Topology</em> screen.<br>
The icon of your Quarkus application should have a yellow circle around it, indicating that the application is misconfigured and failing to enter a healthy state.</p>
<div class="imageblock">
<div class="content">
<img src="_images/devsandbox-deployment-failed.png" alt="devsandbox deployment failed">
</div>
</div>
</li>
<li>
<p>Click on the icon of your Quarkus application. This will open a panel on the right-hand-side of your screen. Click on the <strong>Resources</strong> tab. You will see the <strong>Pods</strong> of your Deployment. Currently you only have a single pod.</p>
</li>
<li>
<p>Click on the <strong>View logs</strong> link next to the pod. In the logs of your application, you will see an error stating the application is misconfigured and is missing configuration properties to be able to connect to Kafka.</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">exec java -Dquarkus.http.host=0.0.0.0 -Djava.util.logging.manager=org.jboss.logmanager.LogManager -XX:+ExitOnOutOfMemoryError -cp . -jar /deployments/quarkus-run.jar
May 25, 2022 7:53:46 AM io.quarkus.runtime.ApplicationLifecycleManager run
ERROR: Failed to start application (with profile prod)
java.lang.IllegalStateException: The property 'kafka.bootstrap.servers' must be set when 'quarkus.kubernetes-service-binding.enabled' has been set to 'true'
	at io.quarkus.kafka.client.runtime.KafkaRecorder.checkBoostrapServers(KafkaRecorder.java:75)
	at io.quarkus.deployment.steps.KafkaProcessor$checkBoostrapServers1072202763.deploy_0(Unknown Source)
	at io.quarkus.deployment.steps.KafkaProcessor$checkBoostrapServers1072202763.deploy(Unknown Source)
	at io.quarkus.runner.ApplicationImpl.doStart(Unknown Source)
	at io.quarkus.runtime.Application.start(Application.java:101)
	at io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:103)
	at io.quarkus.runtime.Quarkus.run(Quarkus.java:67)
	at io.quarkus.runtime.Quarkus.run(Quarkus.java:41)
	at io.quarkus.runtime.Quarkus.run(Quarkus.java:120)
	at io.quarkus.runner.GeneratedMain.main(Unknown Source)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:566)
	at io.quarkus.bootstrap.runner.QuarkusEntryPoint.doRun(QuarkusEntryPoint.java:60)
	at io.quarkus.bootstrap.runner.QuarkusEntryPoint.main(QuarkusEntryPoint.java:31)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bindquarkusapp"><a class="anchor" href="#bindquarkusapp"></a>Binding your Quarkus application to Streams for Apache Kafka</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With your Quarkus application deployed, and your Streams for Apache Kafka instance connected to your OpenShift project, you can now bind your application to your Kafka instance. This is done using the <em>Service Binding Operator</em>, which will inject the configuration values required to connect to your Kafka instance into your Quarkus application. The Quarkus application has been configured to use the <code>quarkus-kubernetes-service-binding</code> extension enabling auto-discovery of the binding files injected into the Quarkus application pod.</p>
</div>
<div class="paragraph">
<p>Service Binding to a managed Kafka instance can be done on the Topology view of the OpenShift console.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the <strong>Topology</strong> view of the <em>Developer Perspective</em> of your sandbox OpenShift environment.</p>
</li>
<li>
<p>Hover over the <strong>stocks-kafka-producer</strong> deployment, and grab the arrow that appears. Drag the arrow to the <strong>KafkaConnection</strong> icon. When reaching the KafkaConnection icon, a text box <code>Create Service Binding</code> appears. Release the arrow. Click <strong>Create</strong> in the <strong>Create Service Binding</strong> pop-up window. The stocks-producer deployment and the KafkaConnection icon are now connected with a solid black arrow.</p>
<div class="imageblock">
<div class="content">
<img src="_images/rhosak-service-binding.png" alt="rhosak service binding">
</div>
</div>
</li>
<li>
<p>Notice that the application is redeployed, and that the icon of the application has a dark blue circle around it, indicating a successful deployment.</p>
</li>
<li>
<p>Click on the stocks-kafka-producer deployment to open the details window, and click on the deployment name to open the full details of the Deployment. Notice that the service binding occurs by injecting a secret into the pod:</p>
<div class="imageblock">
<div class="content">
<img src="_images/service-binding-secret.png" alt="service binding secret">
</div>
</div>
</li>
<li>
<p>Check the logs of the stocks-kafka-producer pod, and notice that the pod successfully connects to the Kafka broker instance.</p>
<div class="listingblock">
<div class="content">
<pre>exec java -Dquarkus.http.host=0.0.0.0 -Djava.util.logging.manager=org.jboss.logmanager.LogManager -XX:+ExitOnOutOfMemoryError -cp . -jar /deployments/quarkus-run.jar
__  ____  __  _____   ___  __ ____  ______
 --/ __ \/ / / / _ | / _ \/ //_/ / / / __/
 -/ /_/ / /_/ / __ |/ , _/ ,&lt; / /_/ /\ \
--\___\_\____/_/ |_/_/|_/_/|_|\____/___/
2022-05-25 08:00:23,682 INFO  [org.apa.kaf.com.sec.aut.AbstractLogin] (main) Successfully logged in.
2022-05-25 08:00:24,055 INFO  [io.sma.rea.mes.kafka] (main) SRMSG18258: Kafka producer kafka-producer-stocks, connected to Kafka brokers 'my-kafka-i-ca-t--btq-jlcbnvd-cg.bf2.kafka.rhcloud.com:443', is configured to write records to 'stocks'
2022-05-25 08:00:24,692 INFO  [io.quarkus] (main) stock-kafka-producer 1.0.0-SNAPSHOT on JVM (powered by Quarkus 2.9.1.Final) started in 3.194s. Listening on: http://0.0.0.0:8080
2022-05-25 08:00:24,692 INFO  [io.quarkus] (main) Profile prod activated.
2022-05-25 08:00:24,692 INFO  [io.quarkus] (main) Installed features: [cdi, kafka-client, smallrye-context-propagation, smallrye-health, smallrye-reactive-messaging, smallrye-reactive-messaging-kafka, vertx]</pre>
</div>
</div>
</li>
<li>
<p>The producer application is sending stock price messages roughly every 5 seconds to the <code>stocks</code> topic.<br>
OpenShift Streams for Apache Kafka has a message viewer functionality that allows you to inspect the contents of messages in a topic.<br>
Navigate to the <strong>Application and Data Services &#8594; Streams for Apache Kafka &#8594; Kafka instances</strong> page of <a href="https://console.redhat.com">console.redhat.com</a>, select your Kafka instance and in the instance window select the <strong>Topics</strong> tab. Click on the <code>stocks</code> topic, and select the <strong>Messages</strong> tab. Notice the stock price messages, with a JSON payload:</p>
<div class="imageblock">
<div class="content">
<img src="_images/openshift-console-rhosak-messages.png" alt="openshift console rhosak messages">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployquarkusconsumerapplication"><a class="anchor" href="#deployquarkusconsumerapplication"></a>Deploying and binding a Quarkus consumer application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have the producer application running and connected to the Kafka instance, you can deploy and bind a consumer application that consumes the messages and displays them on a web page.</p>
</div>
<div class="paragraph">
<p>The source code of this Quarkus application can be found in <a href="https://github.com/btison/stocks-kafka-consumer">this GitHub repo</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve pre-build the container image with the Quarkus application so that you can easily deploy it in your OpenShift project on the Developer Sandbox.</p>
</div>
<div class="paragraph">
<p>The procedure is very similar to what you did in the previous tasks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you are in the <em>Developer Perspective</em> of your sandbox OpenShift environment.</p>
</li>
<li>
<p>Click on the <strong>Container images</strong> card.</p>
</li>
<li>
<p>In the Image name from external registry field, enter:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quay.io/btison/stocks-kafka-consumer</code></pre>
</div>
</div>
</li>
<li>
<p>In the <strong>Runtime icon</strong> field, select <code>quarkus</code>.</p>
</li>
<li>
<p>Select <code>stocks</code> in the <strong>Application name</strong> field.</p>
</li>
<li>
<p>Enter <code>stocks-kafka-producer</code> in the <strong>Name</strong> field.</p>
</li>
<li>
<p>Make sure the <strong>Create a route to the Application</strong> check box is checked. You will need a route to connect to the application from a browser.</p>
</li>
<li>
<p>Leave the other fields set to their default values and click the <strong>Create</strong> button. This will create a new OpenShift Deployment for your Quarkus application.</p>
</li>
<li>
<p>As expected, the application deployment fails.</p>
</li>
<li>
<p>Bind the application to the Kafka instance by creating a connection between the deployment and the KafkaConnection icon.<br>
The application redeploys and sucessfully connects to the Kafka instance.</p>
<div class="imageblock">
<div class="content">
<img src="_images/rhosak-service-binding-2.png" alt="rhosak service binding 2">
</div>
</div>
</li>
<li>
<p>Click on the <strong>Open URL</strong> icon in the upper-right of the stocks-kafka-consumer application icon in the Topology view. This opens a new browser tab showing the default Quarkus welcome page.</p>
</li>
<li>
<p>Add the path <code>/stocks.html</code> to the URL of your Quarkus application. This will open the <em>stocks</em> page of the Quarkus application. The page shows the most recent consumed stock price. Expect the stock price to change roughly every 5 seconds.</p>
<div class="imageblock">
<div class="content">
<img src="_images/devsandbox-quarkus-app.png" alt="devsandbox quarkus app">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have succesfully connected a Quarkus producer and consumer application to a Kafka instance of OpenShift Streams for Apache Kafka using Service Binding.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-connect-streams-apache-kafka.html">2. Connecting OpenShift Streams for Apache Kafka</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
